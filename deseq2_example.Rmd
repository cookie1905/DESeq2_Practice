---
title: "R Notebook"
output: html_notebook
---

```{r}
setwd("C:\\DESeq2_Practice")
getwd()
```

```{r}
library(DESeq2)
library("ggplot2")
```

```{r}
packageVersion("DESeq2")
```

```{r}
rawCount <- readRDS("data\\RNA-seq_RawCounts.Rds")
rawCount
```

```{r}
tissueType <- factor(c(rep("Stroma",10),rep("Normal",10),rep("Tumor",10)))
levels(tissueType)
```
# R will choose a reference level for factors based on alphabetical order
# Normal < Stroma < Tumor
# Can override order using for example levels = c("Stroma", "Normal", "Tumor")
# Make sure first level is always the reference
# Level names should only contain letters, numbers, underscore and period.

```{r}
cancerType <- factor(c(rep(c(rep("squamous",4),rep("adeno",6)),3)))
```

```{r}
colData <- data.frame(sampleName = colnames(rawCount),
                      tissueType=tissueType,
                      cancerType=cancerType)

colData
```
```{r}
table(colData$cancerType, colData$tissueType)
```


# Measure the effect of the tissue type, while controlling for cancer type.
# Put variable of interest (tissueType) at the end of the design formula.

```{r}
  dds <- DESeqDataSetFromMatrix(
    countData = rawCount,
    colData = colData,
    design = ~ cancerType + tissueType
  )
dds
```
```{r}
colData(dds)
```


# Filtering 
# A gene passes the filter if any 3 or more samples have ≥10 reads.

```{r}
smallestGroupSize <- 3
keep <- rowSums(counts(dds) >= 10) >= smallestGroupSize
dds <- dds[keep,]
dds
```


# Differential expression analysis
```{r}
dds <- DESeq(dds)
```

# results for the the last variable in the design,
# comparing its last factor level vs the reference level.
# ~ cancerType + tissueType → results(dds) gives tissueType results.
# ~ tissueType + cancerType → results(dds) gives cancerType results.

```{r}
results(dds) 
```

# For a specific comparison
```{r}
resultsNames(dds) # lists the coefficients estimated by the GLM in DESeq2.
```
# Tumor vs Normal 
# log₂ fold change is calculated as Tumor ÷ Normal:
# - Positive → higher in Tumor
# - Negative → higher in Normal
```{r}
res <- results(dds, name="tissueType_Tumor_vs_Normal")
head(res)
```

# Or use
```{r}
res <- results(dds, contrast=c("tissueType","Tumor","Normal"))
head(res)
```
```{r}
summary(res)
```
```{r}
sum(is.na(res$padj)) # corresponds to outliers [1]: 84, 0.34%

```
```{r}
mcols(res)$description # Information about columns of res 
```
```{r}
resOrdered <- res[order(res$pvalue),] # order results table by the smallest p value

write.csv(as.data.frame(resOrdered), 
          file="data\\tissueType_Tumor_vs_Normal.csv")
```



# padj = FDR-adjusted p-value (p value adjusted for multiple testing.
# alpha = threshold for the adjusted p-value (default is 0.1)
# alpha = 0.1 -> genes with padj < 0.1 are significant.

# Independent filtering:
# DESeq2 looks at the mean normalized count per gene.
# It chooses a threshold that maximizes the number of genes with padj < alpha 
# Genes below this threshold are not included in the multiple testing correction.
# This improves the detection of truly significant genes.

# Note: Independent filtering does not remove genes from your dataset.
# Their padj is set to NA

```{r}
res05 <- results(dds, alpha=0.05) # set alpha to 0.05 instead of 0.1
summary(res05)
```

# Total tested genes: 25042 
# genes with padj < 0.05 are significant
# LFC > 0 (up): 4,636 genes — upregulated in Tumor compared to Normal
# LFC < 0 (down): 3,353 genes — downregulated in Tumor compared to Normal
# 84 genes removed due to extreme count (their padj is set to NA)
# 0 genes filtered by independent filtering 

```{r}
sum(res05$padj < 0.05, na.rm=TRUE) # 4636 + 3353
```
```{r}
sum(is.na(res05$padj))
```

```{r}
resultsNames(dds)
```

# Log fold change shrinkage for visualization and ranking
# only shrinks the log₂ fold changes, not p-values or padj.

```{r}
resLFC <- lfcShrink(dds, coef="tissueType_Tumor_vs_Normal", type="apeglm")
head(resLFC)
```

```{r}
summary(resLFC)
```
# MA-plot
# X axis:
# Low on the left → lowly expressed genes
# High on the right → highly expressed genes

# Y-axis:
# Positive → higher in the numerator level (Tumor)
# Negative → higher in the reference level (Normal)

# Colored points:
# Blue, genes with padj < alpha (0.1) → statistically significant DE genes
# Gray → not significant

```{r}
plotMA(res, ylim=c(-2,2))
```
# more useful to visualize the MA-plot for the shrunken log2 fold changes
# remove the noise associated with log2 fold changes from low count genes.

```{r}
plotMA(resLFC, ylim=c(-2,2))
```
# Plot counts
# Examine the counts of reads for a single gene across the groups
```{r}
which.min(res$padj) # index (row number) of the gene with the smallest padj
```
```{r}
res[3652, ]
```
# ENSG00000169554 is statistically significant
# is expressed more in Normal compared to Tumor


```{r}
d <- plotCounts(dds, gene=which.min(res$padj), intgroup="tissueType", 
                returnData=TRUE)
d
```


```{r}

ggplot(d, aes(x=tissueType, y=count)) + 
  geom_point(position=position_jitter(w=0.1,h=0)) + 
  scale_y_log10(breaks=c(25,100,400))
```
```{r}
resSig <- subset(resOrdered, padj < 0.1)
resSig
```
# Data transformations and visualization
